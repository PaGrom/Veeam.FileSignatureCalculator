# Veeam.FileSignatureCalculator

Тестовое задание в компанию Veeam Software

## Задача

Требуется написать консольную программу на C# для генерации сигнатуры указанного файла. Сигнатура генерируется следующим образом: исходный файл делится на блоки заданной длины (кроме последнего блока), для каждого блока вычисляется значение hash-функции SHA256, и вместе с его номером выводится в консоль.

Программа должна уметь обрабатывать файлы, размер которых превышает объем оперативной памяти, и при этом максимально эффективно использовать вычислительные мощности многопроцессорной системы. При работе с потоками допускается использовать только стандартные классы и библиотеки из .Net (исключая ThreadPool, BackgroundWorker, TPL).


Ожидается реализация с использованием Thread-ов. Путь до входного файла и размер блока задаются в командной строке. В случае возникновения ошибки во время выполнения программы  текст и StackTrace необходимо вывести в консоль.

## Решение

В рамках задачи была разработана консольная утилита Veeam.FileSignatureCalculator.exe.

### Описание

Данная программа принимает на вход путь к файлу и размер блока чтения:
```
FileSignatureCalculator.exe -f C:\test.txt -b 1000000
```
Пример вывода в консоль:
```
Block #2 Hash: 95c4f684b66c29cd03aaa0daa592969ca8526868780483ddb1befb5398eb79e5
Block #0 Hash: 57f6b5d3260f3c38ba5af0be87187779a71e155a98794229c54805844da46673
Block #1 Hash: cf2b9f1c257cbfd4d158c8c3ea592a047a6394d44e733074609d78465ee17f84
Block #4 Hash: b5019fb6ff24d8ddaa9fd1d60ce363d826108311baa18d4255c346ab28e1ad76
Block #3 Hash: 0a670bf6c0352583f8db9c8a378d77d1d1c90d6a4c7cc9410125a220e012a306
Block #5 Hash: 86a4c3a754abb62e5f7688705a1f16281c3f9a29712b6a086807ebe33e7d9466
Block #6 Hash: 1389ecea8aa6e738171b688a1a8ebc0e56109cf5b3a025ceba12a495c4158cca
Block #7 Hash: 29b351f4a4a676c3e8e2fee515f2d2dae535d58492a3d67c757914d0a68bbcbb
Block #9 Hash: 9b12d3d636ab95089a4daff12145855a860c7b472b2db574435eff2ac137fac5
Block #9 Hash: e48c5978b50edae00badb280cef6cd50ff38789a3d36b78f977f80965d7b3d81
```

### Принцип работы

1. Данная утилита создает пул потоков с количеством потоков равным количеству ядер используемой машины.
2. Отдельный поток читает заданный файл поблочно с заданным размером блока. Каждый прочитанный блок кладется в очередь пула потоков на обработку.
3. Каждый поток из пула смотрит в очередь и берет на обработку доступную задачу.
4. Вычисленный SHA256 хэш выводится на экран вместе с порядковым номером блока.
5. В случае ошибки при обработке какой-либо задачи, чтение и обработка блоков останавливается, а на экран выводится описание ошибки и StackTrace. Таким же образом работает прерывние (Ctrl-C).

### Структура проекта

Данная программа представляет из себя набор следующих отдельных сервисов:

* ArgsParserService - служит для парсинга аргументов командной строки
* SettingsValidatorService - валидирует переданные настройки (наличие файла, файл не пустой и т.д.)
* FileHashCalculatorService - основной сервис, который запускает чтение файла и расчет хэшей
* FileReader - вспомогательный сервис, служащий для поблочного чтения заданного файла
* Sha256HashCalculator - считает SHA256 хэш для конкретного блока
* ThreadPool - самописный тредпул, многопоточно обслуживающий очередь задач
* TasksQueueManager - вспомогательный сервис, который кладет задачи в очередь тредпула и следит, чтобы очередь не превышала заданное ограничение длины (если чтение файла будет быстрее обработки блоков, то RAM переполнится от прочитанных блоков)

### Иное

* Veeam.FileSignatureCalculator.Tests - проект содержит базовый набор тестов для тестирования работы сервисов
* Veeam.FileSignatureCalculator.Benchmark - проект содержит небольшой бэнчмарк, считающий время работы утилиты на файлах и блоках разного размера 

### Результат бэнчмарка

``` ini

BenchmarkDotNet=v0.13.1, OS=Windows 10.0.22000
Intel Core i7-8550U CPU 1.80GHz (Kaby Lake R), 1 CPU, 8 logical and 4 physical cores
.NET SDK=6.0.100
  [Host]     : .NET 5.0.12 (5.0.1221.52207), X64 RyuJIT
  Job-QEAVTU : .NET 5.0.12 (5.0.1221.52207), X64 RyuJIT

IterationCount=5  LaunchCount=5  RunStrategy=ColdStart  
WarmupCount=5  

```
|      Method |    FileSize | BlockSize |         Mean |        Error |       StdDev |       Median | Completed Work Items | Lock Contentions |         Gen 0 |         Gen 1 |         Gen 2 | Allocated |
|------------ |------------ |---------- |-------------:|-------------:|-------------:|-------------:|---------------------:|-----------------:|--------------:|--------------:|--------------:|----------:|
| **RunHashCalc** |   **500000000** |    **100000** |   **1,424.3 ms** |    **124.53 ms** |    **166.25 ms** |   **1,393.8 ms** |               **2.0000** |        **1414.0000** |   **114000.0000** |   **114000.0000** |   **113000.0000** |    **490 MB** |
| **RunHashCalc** |   **500000000** |   **1000000** |     **897.5 ms** |     **25.04 ms** |     **33.43 ms** |     **894.0 ms** |               **2.0000** |          **90.0000** |    **15000.0000** |    **15000.0000** |    **15000.0000** |    **478 MB** |
| **RunHashCalc** |   **500000000** |  **10000000** |     **890.5 ms** |     **20.40 ms** |     **27.23 ms** |     **894.3 ms** |               **2.0000** |          **29.0000** |     **4000.0000** |     **4000.0000** |     **4000.0000** |    **477 MB** |
| **RunHashCalc** |  **5000000000** |    **100000** |  **16,848.6 ms** |    **433.59 ms** |    **578.83 ms** |  **16,621.3 ms** |               **2.0000** |       **14138.0000** |  **1208000.0000** |  **1188000.0000** |  **1186000.0000** |  **4,904 MB** |
| **RunHashCalc** |  **5000000000** |   **1000000** |   **8,759.3 ms** |    **170.76 ms** |    **227.96 ms** |   **8,750.1 ms** |               **2.0000** |        **1144.0000** |   **210000.0000** |   **205000.0000** |   **205000.0000** |  **4,785 MB** |
| **RunHashCalc** |  **5000000000** |  **10000000** |   **8,219.7 ms** |     **74.39 ms** |     **99.32 ms** |   **8,195.5 ms** |               **2.0000** |          **65.0000** |    **23000.0000** |    **23000.0000** |    **23000.0000** |  **4,770 MB** |
| **RunHashCalc** | **50000000000** |    **100000** | **160,909.9 ms** |  **5,123.89 ms** |  **6,840.25 ms** | **158,567.8 ms** |               **2.0000** |      **137926.0000** | **11693000.0000** | **11469000.0000** | **11433000.0000** | **49,029 MB** |
| **RunHashCalc** | **50000000000** |   **1000000** | **102,974.1 ms** | **13,174.34 ms** | **17,587.37 ms** |  **89,148.0 ms** |               **2.0000** |       **14362.0000** |  **2096000.0000** |  **2059000.0000** |  **2025000.0000** | **47,840 MB** |
| **RunHashCalc** | **50000000000** |  **10000000** |  **87,171.6 ms** |  **1,927.71 ms** |  **2,573.43 ms** |  **87,156.0 ms** |               **2.0000** |        **1502.0000** |   **298000.0000** |   **298000.0000** |   **274000.0000** | **47,696 MB** |
